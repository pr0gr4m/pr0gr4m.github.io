---
title: "Linux Kernel IPv4"
categories: linux kernel
---

해당 포스트에서는 리눅스 커널의 IPv6 구현에 대해 설명합니다.

# IPv6

IPv6는 IPv4 프로토콜의 주소가 32비트라는 제한된 주소 공간의 한계점으로 인해 지속적인 인터넷 발전에 문제가 예상되어, 이에 대한 대안으로 제안된 네트워크 계층 프로토콜이다.  
IPv6의 커널 구현을 살펴보면 IPv4와 많은 유사점을 찾을 수 있다. 따라서, IPv4 포스트에서 설명한 내용을 기반으로 변경된 부분들을 보이고 새로운 기능을 설명한다.  

## IPv6 주소

IPv6 주소는 세 가지 유형이 있다.
* 유니캐스트 : 인터페이스를 식별하는 주소이다. 유니캐스트 주소로 전송한 패킷은 해당 주소로 식별되는 인터페이스에 전달된다.
* 애니캐스트 : 인터페이스 그룹에 할당되는 주소이다. 애니캐스트 주소로 전송한 패킷은 그룹 내의 인터페이스 중 어느 하나에 전달된다. (라우팅 프로토콜에 따라 가장 가까운 인터페이스에 전달된다.)
* 멀티캐스트 : 인터페이스 그룹에 할당되는 주소이다. 멀티캐스트 주소로 전송한 패킷은 그룹 내의 모든 인터페이스에 전달된다.

IPv6 주소는 16비트씩 8블록으로 구성돼 있으며, 총 128비트다. IPv6 주소는 xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx (x는 16진수)로 표현한다.  
IPv6 주소 중 "::" 는 모두 0(zero)인 주소를 줄여서 표현한 것이다.  
IPv6에는 주소 접두사(prefix)가 사용된다. IPv4의 서브넷 마스크와 같은 방식으로 Address/prefix-length 표기법으로 나타낸다.  

IPv6 주소는 시작하는 비트에 따라 주소 유형이 달라진다.
* 0000 001 (0[2or3]) : NSAP Address
* 001 ([2or3]): Global Unicast Address
    * 전역으로 사용할 수 있는 유니캐스트 주소이다. 공인 IPv4 주소와 유사한 개념이다.
* 1111 1110 10 (FE[8-B]) : Link-Local Unicast Address
    * 물리적으로 연결된 링크에서 사용할 수 있는 유니캐스트 주소이다. 다른 링크의 주소와 해당 주소로 통신이 불가능하다.
* 1111 1110 11 (FE[C-F]) : Site-Local Unicast Address
    * 논리적으로 연결된 사이트에서 사용할 수 있는 유니캐스트 주소이다. RFC 3879에서 사용하지 않기로 지원이 중단되었다.
* 1111 1111 (FF) : Multicast Address

멀티캐스트 주소는 멀티캐스트 그룹을 정의하는 수단을 제공하며, 노드는 하나 이상의 멀티캐스트 그룹에 속할 수 있다.  
멀티캐스트 주소는 FF로 시작한다. 그 다음은 플래그를 나타내는 4비트와 범위를 나타내는 4비트가 따른다. 남은 112 비트는 그룹 ID이다.  
플래그 필드의 4비트는 다음과 같은 의미가 있다.
* 비트 0 : 예약된 필드
* 비트 1 (R Flag) : 값이 1인 경우 주소에 Rendezvous Point가 삽입됐음을 가리킨다.
* 비트 2 (P Flag) : 값이 1인 경우 멀티캐스트 주소가 네트워크 접두사를 기반으로 할당됐음을 가리킨다.
* 비트 3 (T Flag) : 값이 0인 경우 영구적으로 할당된 (Well-known) 멀티캐스트 주소를 가리키며, IANA에서 할당한다. 값이 1인 경우 비영구적으로 할당된 (Temporary) 멀티캐스트 주소를 가리킨다.  

멀티캐스트 주소에는 다음과 같이 특수한 Well-Known 타입의 주소가 있다.  
* FF0x::1 : All-Nodes 멀티캐스트 주소이다. 해당 주소 범위에 포함된 모든 노드가 패킷을 수신한다. (해당 주소를 사용하면 브로드캐스트와 같은 효과를 가진다.)
    * x에는 1(Node-Local Scope)와 2(Link-Local Scope) 값을 가질 수 있다.
* FF0x::2 : All-Routers 멀티캐스트 주소이다. 해당 주소 범위에 포함된 모든 라우터가 패킷을 수신한다.
    * x에는 1(Node-Local Scope)와 2(Link-Local Scope)와 5(Site-Local Scope) 값을 가질 수 있다.  

IPv6에도 IPv4와 마찬가지로 특수한 주소가 있다. (예를 들어, 192.168.x.x나 127.0.0.1와 같은 주소이다)  
다음은 특수한 IPv6 주소와 각 주소의 사용법이다.  
* 각 인터페이스마다 최소한 하나의 Link-Local 유니캐스트 주소가 있어야 한다. 라우터는 Link-Local 출발지 또는 목적지 주소를 가진 어떤 패킷도 포워딩해서는 안 된다. Link-Local 주소는 fe80::/64 접두사로 할당된다.
* 전역 유니캐스트 주소의 일반적인 형식은 다음과 같다. 첫 n비트는 전역 라우팅 접두사이며, 다음 m비트는 서브넷 ID, 나머지 128 - n - m 비트는 인터페이스 ID이다.
    * 전역 라우팅 접두사 : Site에 할당된 값으로, 네트워크 ID 또는 주소 접두사를 의미한다.
    * 서브넷 ID : Site 내의 서브넷 식별자이다.
    * 인터페이스 ID : 서브넷 내에서 유일한 인터페이스 ID로, 호스트 주소를 의미한다.
* IPv6의 루프백 주소는 ::1 이다.
* 모두 0인 주소 ::는 미지정 주소(unspecified address)라고 한다. 이 주소는 중복 주소 탐지에 사용된다. 인터페이스에 해당 주소를 할당할 수 없으며, 목적지 주소로 지정할 수도 없다.
* IPv4 매핑 IPv6 주소(IPv4-Mapped IPv6 Address)는 80비트의 0으로 시작한다. 다음 16비트는 1이고, 남은 32비트는 IPv4 주소이다. 예를 들어, IPv4 주소 192.0.2.128를 ::ffff:192.0.2.128로 매핑할 수 있다.
* IPv4 호환 IPv6 주소(IPv4-Compatible IPv6 Address)는 96비트의 0로 시작하고, 남은 32비트를 IPv4 주소로 할당한다. 예를 들어, IPv4 주소 192.0.2.128를 ::192.0.2.128로 호환할 수 있다.
    * 호환 주소는 실제로 IPv6 주소를 사용하는 듀얼 스택 디바이스에서만 사용할 수 있는 주소이다.

IPv6 주소는 리눅스에서 in6_addr 구조체로 표현한다. 해당 구조체의 정의는 다음과 같다.  
```c
#if __UAPI_DEF_IN6_ADDR
struct in6_addr {
	union {
		__u8		u6_addr8[16];
#if __UAPI_DEF_IN6_ADDR_ALT
		__be16		u6_addr16[8];
		__be32		u6_addr32[4];
#endif
	} in6_u;
#define s6_addr			in6_u.u6_addr8
#if __UAPI_DEF_IN6_ADDR_ALT
#define s6_addr16		in6_u.u6_addr16
#define s6_addr32		in6_u.u6_addr32
#endif
};
#endif /* __UAPI_DEF_IN6_ADDR */
```

IPv6에서 노드는 노드 인터페이스에 설정된 모든 유니캐스트 및 애니캐스트 주소에 대하여 Solicited-Node 멀티캐스트 주소를 계산하고 참가해야 한다.  
Solicited-Node 멀티캐스트 주소는 노드의 유니캐스트와 애니캐스트 주소를 토대로 계산된다.  
접두사 ff02:0:0:0:0:1:ff00::/104에 유니캐스트 또는 애니캐스트 주소 하위 24비트를 덧붙여서 생성한다.  
[addrconf_addr_solict_mult()](https://elixir.bootlin.com/linux/latest/source/include/net/addrconf.h#L432) 함수가 이 Solicited-Node 주소를 계산한다.  
[addrconf_join_solict](https://elixir.bootlin.com/linux/latest/source/net/ipv6/addrconf.c#L2162) 함수는 의뢰한 주소 멀티캐스트 그룹에 참가한다.  

## IPv6 헤더

