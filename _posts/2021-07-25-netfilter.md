---
title: "Linux Kernel Netfilter"
categories: linux kernel
---

해당 포스트에서는 리눅스 커널의 넷필터에 대해 설명합니다.
넷필터 서브시스템은 네트워크 스택 내에서 패킷이 이동하는 여러 지점에 콜백을 등록하는 것을 비롯해 주소나 포트 변경, 패킷 drop, 로깅 등과 같이 패킷 상의 다양한 동작을 수행할 수 있는 프레임워크를 제공합니다.  

## 넷필터 프레임워크

넷필터 서브시스템이 수행할 수 있는 기능의 예시는 다음과 같다.  
* 패킷 선택 및 필터링 (iptables)
* 네트워크 주소 변환 (NAT)
* 패킷 맹글링(Mangling; 라우팅 전후로 패킷 헤더의 내용을 수정)
* 연결 추적
* 네트워크 통계 수집

리눅스 커널 넷필터 서브시스템을 기반으로 한 프레임워크 대표 예시는 다음과 같다.  
* iptables : 넷필터에 대한 관리 계층을 제공하는 유저 스페이스 프레임워크로, 넷필터 규칙의 추가와 삭제, 통계 표시, 테이블 추가, 테이블 카운터 초기화 등의 기능이 있다.  
* IPVS : transport 계층의 로드밸런싱 기능(Layer 4 LAN Switching)을 제공하는 IP 가상 서버 솔루션이다.
* IPSet : ipset 유틸리티로 IP 주소, 포트 주소, MAC 주소, 인터페이스 이름 등을 저장할 수 있는 기능을 제공하는 프레임워크다.

## 넷필터 훅

네트워크 스택에는 넷필터 훅을 등록할 수 있는 다섯 개의 지점이 있다.  
다섯 개의 훅의 이름은 다음과 같다.  
* NF_INET_PRE_ROUTING : ```ip_rcv()``` 함수와 ```ipv6_rcv()``` 함수에 있다. 라우팅 서브시스템 탐색을 수행하기 전 모든 수신 패킷이 도착하는 첫 번째 훅 지점이다.
* NF_INET_LOCAL_IN : ```ip_local_deliver()``` 함수와 ```ip6_input()``` 함수에 있다. 로컬 호스트로 향하는 모든 수신 패킷은 라우팅 서브시스템 탐색을 수행한 후 이 훅 지점에 도착한다.
* NF_INET_FORWARD : ```ip_forward()``` 함수와 ```ip6_forward()``` 함수에 있다. 포워딩 되는 모든 패킷은 라우팅 서브시스템 탐색을 수행한 후 이 훅 지점에 도착한다.
* NF_INET_POST_ROUTING : ```ip_output()``` 함수와 ```ip6_finish_output2()``` 함수에 있다. 포워딩되거나 로컬호스트에서 생성되어 전송되는 모든 송신 패킷은 라우팅 서브시스템 탐색을 수행한 후 해당 지점에 도착한다. NF_INET_FORWARD/NF_INET_LOCAl_OUT 보다 후에 도착하는 지점이다.
* NF_INET_LOCAL_OUT : ```__ip_local_out()``` 함수와 ```__ip6_local_out()``` 함수에 있다. 로컬 호스트에서 생성된 모든 송신 패킷이 도착하는 첫 번째 훅 지점이다.

